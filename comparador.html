<!DOCTYPE html>
<html>
  <head>
    <title>Comparador de PDFs</title>
  </head>
  <body>
    <h1>Comparador de Termo de Referência (PDFs)</h1>
    <form id="pdf-form">
      <label for="pdf1">PDF 1:</label>
      <input type="file" id="pdf1" name="pdf1" accept=".pdf"><br><br>
      <label for="pdf2">PDF 2:</label>
      <input type="file" id="pdf2" name="pdf2" accept=".pdf"><br><br>
      <label for="pages">Páginas:</label>
      <input type="text" id="pages" name="pages" placeholder="Exemplo: 1,3-5,7 ou deixe em branco para comparar todas as páginas"><br><br>
      <input type="submit" value="Comparar">
    </form>
    <div id="result"></div>

    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff@latest"></script>
    <script>
      function parsePages(pagesString) {
        if (!pagesString) {
          return null;
        }
        const pages = [];
        const ranges = pagesString.split(',');
        ranges.forEach(range => {
          if (range.includes('-')) {
            const [start, end] = range.split('-').map(Number);
            for (let i = start; i <= end; i++) {
              pages.push(i);
            }
          } else {
            pages.push(Number(range));
          }
        });
        return pages;
      }

      async function getPdfText(file, pages) {
        const fileReader = new FileReader();
        fileReader.readAsArrayBuffer(file);
        await new Promise(resolve => fileReader.onload = resolve);
        const typedarray = new Uint8Array(fileReader.result);
        const pdf = await pdfjsLib.getDocument(typedarray).promise;
        let result = '';
        if (pages) {
          for (let i = 0; i < pages.length; i++) {
            if (pages[i] >= 1 && pages[i] <= pdf.numPages) {
              const page = await pdf.getPage(pages[i]);
              const textContent = await page.getTextContent();
              textContent.items.forEach(item => {
                result += item.str + ' ';
              });
            }
          }
        } else {
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            textContent.items.forEach(item => {
              result += item.str + ' ';
            });
          }
        }
        return result;
      }

      document.getElementById('pdf-form').addEventListener('submit', async event => {
        event.preventDefault();

        const pdf1 = document.getElementById('pdf1').files[0];
        const pdf2 = document.getElementById('pdf2').files[0];
        const pagesString = document.getElementById('pages').value;

        if (!pdf1 || !pdf2) {
          alert('Por favor, selecione dois arquivos PDF para comparar.');
          return;
        }

        const pages = parsePages(pagesString);

        const text1 = await getPdfText(pdf1, pages);
        const text2 = await getPdfText(pdf2, pages);

        const differences = Diff.diffLines(text1, text2);

        if (differences.length === 1 && !differences[0].added && !differences[0].removed) {
          document.getElementById('result').innerHTML = '<p>Os arquivos PDF são idênticos.</p>';
        } else {
          let resultHTML = '<p>Os arquivos PDF são diferentes.</p><ul>';
          let lineNumber = 1;
          differences.forEach(part => {
            if (part.added || part.removed) {
              const label = part.added ? 'Texto novo' : 'Texto antigo';
              const color = part.added ? 'green' : 'red';
              const lines = part.value.split('\n');
              lines.forEach(line => {
                if (line) {
                  resultHTML += `<li>${label} ${lineNumber}: <span style="color: ${color}">${line}</span></li>`;
                }
                lineNumber++;
              });
            } else {
              lineNumber += part.count;
            }
          });
          resultHTML += '</ul>';
          document.getElementById('result').innerHTML = resultHTML;
        }
      });
    </script>
  </body>
</html>
