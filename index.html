<!DOCTYPE html>
<html>
  <head>
    <title>Comparador de PDFs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"></script>
  </head>
  <body>
  
  <div class="row">
    <div class="col-md-1"></div>
    <div class="col-md-10">
    <div class="card border-primary mt-3">
    <div class="card-header text-center bg-primary text-white">
        <h5 class="text-center">Comparar Termo de Referência (PDF)</h5>
    </div>
    <div class="card-body">
        <form id="pdf-form" class="row g-3">
            <div class="col-md-6">
                <label for="pdf1" class="form-label">PDF 1:</label>
                <input type="file" id="pdf1" name="pdf1" class="form-control form-control-sm" accept=".pdf">
            </div>
            <div class="col-md-6">
                <label for="pdf2" class="form-label">PDF 2:</label>
                <input type="file" id="pdf2" name="pdf2" class="form-control form-control-sm" accept=".pdf">
            </div>

            <div class="col-md-6">
                <label for="pages" class="form-label">Páginas:</label>
                <input type="text" id="pages" class="form-control form-control-sm" name="pages" placeholder="Exemplo: 1,3-5,7 ou deixe em branco para comparar todas as páginas">
                <div id="pagesHelpBlock" class="form-text text-danger">
                    Prencha o campo com as páginas desejadas ou deixe em branco para comparar todas as páginas, exemplo de preenchimento (1,3-5,7).
                </div>
            </div>
            <button type="submit" class="btn btn-sm btn-primary">Comparar</button>
        </form>
    </div>
    <div class="card-footer resulttext-muted">
    	<div id="loading" style="display: none; text-align: center;">Comparando...</div>
        <p id="result" class="lh-1"></p>
    </div>
</div>
<script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>
<script src="https://cdn.jsdelivr.net/npm/diff@latest"></script>
<script>
    function parsePages(pagesString) {
        if (!pagesString) {
            return null;
        }
        const pages = [];
        const ranges = pagesString.split(',');
        ranges.forEach(range => {
            if (range.includes('-')) {
                const [start, end] = range.split('-').map(Number);
                for (let i = start; i <= end; i++) {
                    pages.push(i);
                }
            } else {
                pages.push(Number(range));
            }
        });
        return pages;
    }

    async function getPdfText(file, pages) {
    const fileReader = new FileReader();
    fileReader.readAsArrayBuffer(file);
    await new Promise(resolve => fileReader.onload = resolve);
    const typedarray = new Uint8Array(fileReader.result);
    const pdf = await pdfjsLib.getDocument(typedarray).promise;
    const result = [];
    if (pages) {
        for (let i = 0; i < pages.length; i++) {
            if (pages[i] >= 1 && pages[i] <= pdf.numPages) {
                const page = await pdf.getPage(pages[i]);
                const textContent = await page.getTextContent();
                let pageText = '';
                textContent.items.forEach(item => {
                    pageText += item.str + ' ';
                });
                result.push(pageText);
            }
        }
    } else {
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            let pageText = '';
            textContent.items.forEach(item => {
                pageText += item.str + ' ';
            });
            result.push(pageText);
        }
    }
    return result;
}

document.getElementById('pdf-form').addEventListener('submit', async event => {
    event.preventDefault();

    // Mostrar o elemento de carregamento
    document.getElementById('loading').style.display = 'block';

    const pdf1 = document.getElementById('pdf1').files[0];
    const pdf2 = document.getElementById('pdf2').files[0];
    const pagesString = document.getElementById('pages').value;

    if (!pdf1 || !pdf2) {
        alert('Por favor, selecione dois arquivos PDF para comparar.');
        // Ocultar o elemento de carregamento
        document.getElementById('loading').style.display = 'none';
        return;
    }

    const pages = parsePages(pagesString);

    const text1 = await getPdfText(pdf1, pages);
    const text2 = await getPdfText(pdf2, pages);

    let resultHTML = '<ul class="list-group list-group-flush">';
    let identical = true;
    for (let i = 0; i < text1.length; i++) {
        const differences = Diff.diffWords(text1[i], text2[i]);
        if (differences.length !== 1 || differences[0].added || differences[0].removed) {
            identical = false;
            resultHTML += `<li class="list-group-item"><h5>Página ${i + 1}</h5></li>`;
            differences.forEach(part => {
                if (part.added || part.removed) {
                    const label = part.added ? 'Texto novo' : 'Texto antigo';
                    resultHTML += `<li class="list-group-item">${label}: `;
                    if (part.added) {
                        resultHTML += `<ins style="color: green">${part.value}</ins>`;
                    } else {
                        resultHTML += `<del style="color: red; text-decoration: line-through;">${part.value}</del>`;
                    }
                    resultHTML += '</li>';
                }
            });
        }
    }
    resultHTML += '</ul>';

    if (identical) {
        document.getElementById('result').innerHTML = '<div class="alert alert-primary align-items-center text-center" role="alert">Os arquivos (PDF) são idênticos.</div>';
    } else {
        document.getElementById('result').innerHTML = '<div class="alert alert-warning align-items-center" role="alert">Os arquivos (PDF) são diferentes. Confira abaixo o texto original com suas respectivas alterações.</div>' + resultHTML;
    }

    // Ocultar o elemento de carregamento
    document.getElementById('loading').style.display = 'none';
    
    // Resetar o formulário
    document.getElementById('pdf-form').reset();
});
</script>
  </body>
</html>
